<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        #niivue-canvas { width: 100%; height: 100%; display: block; pointer-events: auto; }
    </style>
</head>
<body>
    <canvas id="niivue-canvas"></canvas>
    <script>{{ niivue_lib_content|safe }}</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script>
        console.log('Starting minimal NiiVue viewer...');
        
        if (typeof niivue === 'undefined') {
            console.error('Niivue library not loaded!');
        } else {
            console.log('NiiVue library loaded successfully');

            const nv = new niivue.Niivue({
                isColorbar: false,
                loadingText: 'loading ...',
                dragAndDropEnabled: false,
                isResizeCanvas: true,
                crosshairWidth: 1,
                crosshairColor: [1, 0, 0, 1],
                backColor: [0, 0, 0, 1]
            });
            nv.attachTo('niivue-canvas');

            // Minimal template variable loading
            let volumeList = [];
            let overlayColors = [];
            
            try {
                volumeList = {{ volume_list_js|safe }};
            } catch (e) {
                console.error('Error loading volumeList:', e);
            }
            
            try {
                overlayColors = {{ overlay_colors_js|safe }};
            } catch (e) {
                console.error('Error loading overlayColors:', e);
            }

            console.log('VolumeList:', volumeList);
            console.log('OverlayColors:', overlayColors);

            // Load Vista3D colormap
            fetch('/assets/colormaps/vista3d_voxels.json')
                .then(response => response.json())
                .then(data => {
                    if (data.colormaps && data.colormaps.vista3d_anatomical) {
                        const colormap = data.colormaps.vista3d_anatomical;
                        const normalizedColormap = {
                            R: colormap.R.map(v => v / 255),
                            G: colormap.G.map(v => v / 255),
                            B: colormap.B.map(v => v / 255),
                            A: colormap.A.map(v => v / 255),
                            labels: colormap.labels
                        };
                        nv.addColormap('vista3d_anatomical', normalizedColormap);
                        console.log('Vista3D colormap loaded');
                    }
                })
                .catch(error => {
                    console.warn('Could not load Vista3D colormap:', error);
                });

            // Load volumes
            nv.loadVolumes(volumeList).then(() => {
                console.log('Volumes loaded successfully');
                
                // Simple overlay processing
                if (nv.volumes && nv.volumes.length > 1) {
                    for (let i = 1; i < nv.volumes.length; i++) {
                        const overlayVol = nv.volumes[i];
                        if (overlayVol) {
                            overlayVol.opacity = 0.7;
                            
                            // Check if this is all segmentation
                            const overlayIndex = i - 1;
                            if (overlayColors && overlayIndex < overlayColors.length && 
                                overlayColors[overlayIndex] && overlayColors[overlayIndex].is_all_segmentation) {
                                console.log('Applying Vista3D colormap to all segmentation');
                                nv.setColormap(overlayVol.id, 'vista3d_anatomical');
                            }
                        }
                    }
                }
                
                // Set slice type
                const sliceType = 0; // Default to single view
                nv.setSliceType(sliceType);
                console.log('Viewer setup complete');
                
            }).catch((error) => {
                console.error('Error loading volumes:', error);
            });
        }
    </script>
</body>
</html>
