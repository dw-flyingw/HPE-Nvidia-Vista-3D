version: '3.8'

services:
  vista3d-server:
    image: nvcr.io/nim/nvidia/vista3d:1.0.0
    container_name: vista3d-server-standalone
    ports:
      - "8000:8000"
    environment:
      - NGC_API_KEY=${NGC_API_KEY}
      - NGC_ORG_ID=${NGC_ORG_ID}
      - LOCAL_NIM_CACHE=/workspace/.cache/nim
      - IMAGE_SERVER=${IMAGE_SERVER:-http://localhost:8888}
      - VISTA3D_SERVER=http://localhost:8000
      - IGNORE_SSL_ERRORS=True
      - IMAGE_URI_ALLOW_REDIRECTS=True
      - IMAGE_URI_HTTPS_ONLY=False
      - ALLOW_LOCAL_FILES=True
      - ENABLE_CONTAINER_PATHS=True
      - ENABLE_FILE_ACCESS=True
      - ALLOW_ABSOLUTE_PATHS=True
      - ALLOW_RELATIVE_PATHS=True
      - ALLOW_FILE_PROTOCOL=True
      - ALLOW_LOCAL_PATHS=True
      - DISABLE_URL_VALIDATION=True
      - ALLOW_ABSOLUTE_FILE_PATHS=True
      - ALLOW_RELATIVE_FILE_PATHS=True
      - FILE_ACCESS_MODE=local
      - LOCAL_FILE_ACCESS=True
      - ALLOW_ANY_IMAGE_SERVER_HOST=True
      - ALLOW_EXTERNAL_NETWORK_ACCESS=True
      - DISABLE_HOST_VALIDATION=True
      - ALLOW_ANY_IP_ACCESS=True
      - DISABLE_DOMAIN_WHITELIST=True
      - ALLOW_HTTP_ACCESS=True
      - ALLOW_HTTPS_ACCESS=True
      - ALLOW_REMOTE_ACCESS=True
      - ALLOW_CROSS_ORIGIN=True
      - DISABLE_CORS=True
      - ALLOW_ANY_ORIGIN=True
      - ALLOW_ANY_HOST=True
      - DISABLE_ORIGIN_VALIDATION=True
      - ALLOW_WILDCARD_HOSTS=True
      - DISABLE_IP_VALIDATION=True
      - ALLOW_PRIVATE_IPS=True
      - ALLOW_PUBLIC_IPS=True
      - ALLOW_LOCALHOST=True
      - ALLOW_LOOPBACK=True
      - DISABLE_NETWORK_RESTRICTIONS=True
      - ENABLE_EXTERNAL_ACCESS=True
      - ALLOW_IMAGE_SERVER_ACCESS=True
      - DISABLE_IMAGE_SERVER_VALIDATION=True
      - CORS_ALLOW_ORIGINS=*
      - CORS_ALLOW_METHODS=GET,POST,PUT,DELETE,OPTIONS
      - CORS_ALLOW_HEADERS=*
      - CORS_ALLOW_CREDENTIALS=True
      - CORS_EXPOSE_HEADERS=*
      - CORS_MAX_AGE=3600
      - VISTA3D_ALLOW_EXTERNAL_IMAGES=True
      - VISTA3D_DISABLE_IMAGE_VALIDATION=True
      - VISTA3D_ALLOW_ANY_URL=True
      - VISTA3D_DISABLE_URL_VALIDATION=True
      - VISTA3D_ALLOW_REMOTE_FILES=True
      - VISTA3D_DISABLE_FILE_VALIDATION=True
      - VISTA3D_ENABLE_NETWORK_ACCESS=True
      - VISTA3D_ALLOW_HTTP_DOWNLOADS=True
      - VISTA3D_ALLOW_HTTPS_DOWNLOADS=True
      - VISTA3D_DISABLE_SSL_VERIFICATION=True
      - VISTA3D_ALLOW_INSECURE_CONNECTIONS=True
      - VISTA3D_TIMEOUT=300
      - VISTA3D_MAX_RETRIES=3
      - WORKSPACE_IMAGES_PATH=/workspace/output/nifti
      - WORKSPACE_OUTPUTS_PATH=/workspace/output
      - WORKSPACE_ROOT=/workspace
      - CUDA_VISIBLE_DEVICES=0
      - NVIDIA_VISIBLE_DEVICES=0
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - CUDA_LAUNCH_BLOCKING=1
      - TORCH_USE_CUDA_DSA=1
      - DOMAIN_WHITELIST=[".*","http://.*","https://.*","http://.*:.*","https://.*:.*","file:///.*","*"]
      - SUPPORTED_IMAGE_EXT=[".nrrd",".nii",".nii.gz",".dcm"]
    volumes:
      - ${OUTPUT_FOLDER:-./output}:/workspace/output
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - vista3d-network

networks:
  vista3d-network:
    external: true


