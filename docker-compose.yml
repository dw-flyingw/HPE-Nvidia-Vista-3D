version: '3.8'

services:
  # Main Streamlit Application
  vista3d-app:
    build: .
    container_name: hpe-nvidia-vista3d-app
    ports:
      - "8501:8501"
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_THEME_BASE=dark
      - IMAGE_SERVER=http://image-server:8888
      - EXTERNAL_IMAGE_SERVER=http://localhost:8888
      - OUTPUT_FOLDER=/app/output
      - DICOM_FOLDER=/app/dicom
      - VISTA3D_SERVER=http://host.docker.internal:8000
      - VISTA3D_API_KEY=${VISTA3D_API_KEY}
      - DOCKER_CONTAINER=true
      # OpenGL headless rendering support
      - DISPLAY=:99
      - LIBGL_ALWAYS_SOFTWARE=1
      - MESA_GL_VERSION_OVERRIDE=3.3
      - MESA_GLSL_VERSION_OVERRIDE=330
    volumes:
      - ${OUTPUT_FOLDER}:/app/output
      - ${DICOM_FOLDER}:/app/dicom
      - ./.env:/app/.env
    networks:
      - local-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    depends_on:
      - image-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Local Image Server
  image-server:
    build: .
    container_name: vista3d-image-server
    ports:
      - "8888:8888"
    command: ["uv", "run", "python", "utils/image_server.py"]
    environment:
      - VISTA3D_SERVER=http://host.docker.internal:8000
      - VISTA3D_API_KEY=${VISTA3D_API_KEY}
      - OUTPUT_FOLDER=/app/output
      - DICOM_FOLDER=/app/dicom
      - DOCKER_CONTAINER=true
    volumes:
      - ${OUTPUT_FOLDER}:/app/output
      - ${DICOM_FOLDER}:/app/dicom
      - ./.env:/app/.env
    networks:
      - local-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Optional: Local Vista3D Server (for testing/development)
  vista3d-server:
    image: nvcr.io/nim/nvidia/vista3d:1.0.0
    container_name: vista3d-server-local
    ports:
      - "8000:8000"
    environment:
      - NGC_API_KEY=${NGC_API_KEY}
      - NGC_ORG_ID=${NGC_ORG_ID}
      - IMAGE_SERVER=http://image-server:8888
      - VISTA3D_SERVER=http://localhost:8000
      - IMAGE_URI_HTTPS_ONLY=False
      - CUDA_VISIBLE_DEVICES=0
      - NVIDIA_VISIBLE_DEVICES=0
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - ${OUTPUT_FOLDER:-./output}:/workspace/output
    networks:
      - local-network
    restart: unless-stopped
    profiles:
      - local-vista3d
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

networks:
  local-network:
    driver: bridge
  # External network for remote Vista3D server connectivity
  external-network:
    external: true
    name: vista3d-external

volumes:
  output-data:
  dicom-data:
